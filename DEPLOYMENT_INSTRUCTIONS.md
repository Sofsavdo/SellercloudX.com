# ğŸš€ Production Deployment Instructions

## Barcha Muammolar Tuzatildi

### Tuzatilgan Muammolar:
1. âœ… CORS xatoliklari (`*.onrender.com` wildcard support)
2. âœ… Static file 500 xatolari (MIME type fixes)
3. âœ… Environment detection (production mode)
4. âœ… Build process (Docker multi-stage build)
5. âœ… WebSocket production URL

---

## Deployment Qadamlari

### 1. Main Branchga Merge

```bash
# Fix branchdan main'ga o'ting
git checkout main

# Fix branchni merge qiling
git merge fix/websocket-production-url

# Main'ga push qiling
git push origin main
```

### 2. Render Dashboard'da Sozlash

**MUHIM:** Render.com dashboard'da quyidagi sozlamalarni tekshiring:

#### A. Environment Variables
Render dashboard â†’ Environment â†’ Environment Variables:

```env
NODE_ENV=production
PORT=5000
DATABASE_URL=<your-database-url>
SESSION_SECRET=<auto-generated-or-custom>
CORS_ORIGIN=https://biznesyordam.uz,https://www.biznesyordam.uz
FRONTEND_ORIGIN=https://biznesyordam.uz
VITE_API_URL=https://biznesyordam-backend.onrender.com
DATABASE_AUTO_SETUP=true
```

#### B. Build & Deploy Settings
Render dashboard â†’ Settings:

- **Environment:** Docker
- **Dockerfile Path:** `./Dockerfile`
- **Docker Command:** (leave empty, uses CMD from Dockerfile)
- **Auto-Deploy:** Yes (recommended)

### 3. Manual Deploy (Agar Kerak Bo'lsa)

Agar avtomatik deploy ishlamasa:

1. Render dashboard'ga kiring
2. Service'ni tanlang
3. "Manual Deploy" â†’ "Deploy latest commit" bosing
4. "Clear build cache & deploy" tanlang (birinchi marta)

---

## Build Process Tushuntirish

### Docker Multi-Stage Build

**Stage 1: Builder**
```dockerfile
FROM node:20-alpine AS builder
- npm ci (barcha dependencies)
- npm run build:client (Vite build)
- npm run build:server (esbuild)
- Verification (dist/public va dist/index.js)
```

**Stage 2: Runner**
```dockerfile
FROM node:20-alpine AS runner
- npm ci --omit=dev (faqat production deps)
- Copy dist/ from builder
- Verify artifacts exist
- Run: node dist/index.js
```

### Build Verification

Build jarayonida quyidagilar tekshiriladi:

1. **Client build:** `dist/public` papkasi mavjudligi
2. **Server build:** `dist/index.js` fayli mavjudligi
3. **Runtime check:** Container start'da yana tekshiriladi

Agar biror artifact yo'q bo'lsa, build fail bo'ladi va xato xabari ko'rsatiladi.

---

## Deployment Logs

### Kutilayotgan Loglar

**Build Stage:**
```
ğŸ—ï¸  Building client...
âœ… Client build done
total 1234
drwxr-xr-x    5 root     root          4096 Nov  7 06:00 public
-rw-r--r--    1 root     root           123 Nov  7 06:00 index.html

ğŸ—ï¸  Building server...
âœ… Server build done
total 567
-rw-r--r--    1 root     root        123456 Nov  7 06:00 index.js
```

**Runtime Stage:**
```
ğŸ“‚ Checking build artifacts...
total 567
-rw-r--r--    1 root     root        123456 Nov  7 06:00 index.js
drwxr-xr-x    5 root     root          4096 Nov  7 06:00 public
âœ… All build artifacts present
```

**Server Start:**
```
ğŸ”§ Environment: production
ğŸ“ Serving static files from: /app/dist/public
âœ… Server running on port 5000
```

### Xato Loglar

Agar build fail bo'lsa:
```
âŒ ERROR: dist/public not found!
```

Agar server start fail bo'lsa:
```
âŒ Build directory not found: /app/dist/public
âš ï¸  Please run 'npm run build' first
ğŸ“‚ Current directory: /app
ğŸ“‚ Directory contents: ...
```

---

## Verification Checklist

Deploy'dan keyin quyidagilarni tekshiring:

### 1. Server Health
```bash
curl https://biznesyordam-3t51.onrender.com/api/health
```
Expected: `{"status":"ok"}`

### 2. Static Files
Browser'da ochib, DevTools â†’ Network tab:

- âœ… `index.html` - 200 OK, `text/html`
- âœ… `index-*.css` - 200 OK, `text/css; charset=utf-8`
- âœ… `index-*.js` - 200 OK, `application/javascript; charset=utf-8`
- âœ… `*-vendor-*.js` - 200 OK, `application/javascript; charset=utf-8`

### 3. Console Errors
Browser DevTools â†’ Console:

- âŒ No CORS errors
- âŒ No "MIME type not supported" errors
- âŒ No 500 errors
- âœ… Application loads successfully

### 4. WebSocket Connection
Console'da quyidagi xabarni ko'ring:
```
ğŸ”Œ Connecting to WebSocket: wss://biznesyordam-backend.onrender.com/ws
ğŸ”Œ WebSocket connected
```

---

## Troubleshooting

### Problem: Static files 500 error

**Sabab:** Build muvaffaqiyatsiz yoki `dist/public` yo'q

**Yechim:**
1. Render logs'ni tekshiring
2. Build stage'da xato bormi?
3. "Clear build cache & deploy" qiling
4. Dockerfile'ni tekshiring

### Problem: CORS errors

**Sabab:** Environment variables noto'g'ri

**Yechim:**
1. Render dashboard â†’ Environment Variables
2. `CORS_ORIGIN` to'g'ri o'rnatilganini tekshiring
3. Server logs'da `âœ… CORS allowed for Render domain` xabarini qidiring

### Problem: CSS MIME type error

**Sabab:** Middleware ishlamayapti

**Yechim:**
1. Server logs'da `ğŸ“ Serving static files from: ...` xabarini tekshiring
2. `NODE_ENV=production` o'rnatilganini tasdiqlang
3. Server restart qiling

### Problem: WebSocket connection fails

**Sabab:** `VITE_API_URL` noto'g'ri

**Yechim:**
1. `VITE_API_URL` environment variable'ni tekshiring
2. Backend URL to'g'ri ekanligini tasdiqlang
3. Client'ni rebuild qiling

---

## Performance Optimization

### Cache Headers

Production'da static fayllar uchun:
- **JS/CSS/Images:** 1 yil cache (`max-age=31536000, immutable`)
- **HTML:** No cache (`no-cache, no-store, must-revalidate`)

Bu:
- âœ… Tezroq page load
- âœ… Kamroq server load
- âœ… Yaxshi user experience

### Docker Image Size

Multi-stage build:
- **Builder stage:** ~500MB (barcha deps)
- **Runtime stage:** ~150MB (faqat production deps)
- **Savings:** ~70% kichikroq image

---

## Rollback Plan

Agar deployment muvaffaqiyatsiz bo'lsa:

### Option 1: Git Revert
```bash
git revert HEAD~5..HEAD
git push origin main
```

### Option 2: Render Dashboard
1. Render dashboard â†’ Deployments
2. Oldingi muvaffaqiyatli deployment'ni tanlang
3. "Redeploy" bosing

### Option 3: Branch Rollback
```bash
git checkout main
git reset --hard <previous-commit-hash>
git push origin main --force
```

---

## Post-Deployment Tasks

### 1. Monitor Logs
Birinchi 10-15 daqiqa logs'ni kuzating:
```bash
# Render dashboard â†’ Logs
# Yoki CLI orqali:
render logs -s biznesyordam-backend
```

### 2. Test All Features
- [ ] Login/Logout
- [ ] Partner registration
- [ ] Product management
- [ ] Fulfillment requests
- [ ] Analytics dashboard
- [ ] WebSocket notifications

### 3. Performance Check
- [ ] Page load time < 3s
- [ ] API response time < 500ms
- [ ] No memory leaks
- [ ] CPU usage normal

### 4. Update Documentation
- [ ] Update README.md with new deployment info
- [ ] Document any environment-specific configs
- [ ] Update API documentation if needed

---

## Success Criteria

Deployment muvaffaqiyatli hisoblanadi agar:

âœ… Build muvaffaqiyatli tugaydi  
âœ… Server start bo'ladi va health check pass qiladi  
âœ… Static fayllar to'g'ri MIME type bilan serve qilinadi  
âœ… CORS xatolari yo'q  
âœ… WebSocket ulanadi  
âœ… Barcha funksiyalar ishlaydi  
âœ… Performance yaxshi  
âœ… Xatolik yo'q  

---

## Support

Agar muammolar davom etsa:

1. **Logs:** Render dashboard â†’ Logs
2. **Metrics:** Render dashboard â†’ Metrics
3. **Database:** Check DATABASE_URL connection
4. **Environment:** Verify all env vars set correctly

---

**Branch:** `fix/websocket-production-url`  
**Status:** âœ… Ready for production  
**Last Updated:** 2025-11-07  

**Commits:**
- `6076ffc` - Docker and build improvements
- `d7857f2` - Static file serving fixes
- `180fe44` - CORS fixes
- `ffe20c7` - WebSocket URL fix

ğŸš€ **Deploy qiling va test qiling!**
